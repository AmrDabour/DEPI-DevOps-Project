name: Terraform Infrastructure Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
      working_directory:
        description: 'Terraform directory'
        required: false
        type: choice
        default: 'terraform'
        options:
          - terraform
          - .github/terraform
      auto_approve:
        description: 'Auto approve (use with caution!)'
        required: false
        type: boolean
        default: false
  
  pull_request:
    paths:
      - 'terraform/**'
      - '.github/terraform/**'
    branches: [ main, master ]

env:
  TF_VERSION: '1.6.0'
  TF_IN_AUTOMATION: 'true'

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event.inputs.action == 'plan'
    
    defaults:
      run:
        working-directory: ${{ github.event.inputs.working_directory || 'terraform' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.GCP_PROJECT_ID }}-tfstate" \
            -backend-config="prefix=terraform/state"

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var="gcp_project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -no-color \
            -out=tfplan
        continue-on-error: true

      - name: Save Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.run_number }}
          path: ${{ github.event.inputs.working_directory || 'terraform' }}/tfplan
          retention-days: 30

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: ${{ steps.plan.outputs.stdout }}
        with:
          script: |
            const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${process.env.PLAN}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Working Directory: \`${{ github.event.inputs.working_directory || 'terraform' }}\`, Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Plan Summary
        run: |
          echo "## Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.plan.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "**Format Check:** ${{ steps.fmt.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "**Validation:** ${{ steps.validate.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Plan saved as artifact: tfplan-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'apply'
    environment: 
      name: production
      url: https://console.cloud.google.com/kubernetes/list?project=${{ secrets.GCP_PROJECT_ID }}
    
    defaults:
      run:
        working-directory: ${{ github.event.inputs.working_directory || 'terraform' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.GCP_PROJECT_ID }}-tfstate" \
            -backend-config="prefix=terraform/state"

      - name: Terraform Plan
        run: |
          terraform plan \
            -var="gcp_project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -out=tfplan

      - name: Terraform Apply
        run: |
          if [ "${{ github.event.inputs.auto_approve }}" = "true" ]; then
            terraform apply -auto-approve tfplan
          else
            terraform apply tfplan
          fi

      - name: Get Outputs
        id: outputs
        run: |
          echo "cluster_name=$(terraform output -raw cluster_name)" >> $GITHUB_OUTPUT
          echo "cluster_endpoint=$(terraform output -raw cluster_endpoint)" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Apply Summary
        run: |
          echo "## Terraform Apply Complete! ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster Name:** ${{ steps.outputs.outputs.cluster_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster Endpoint:** ${{ steps.outputs.outputs.cluster_endpoint }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Connect to cluster: \`gcloud container clusters get-credentials ${{ steps.outputs.outputs.cluster_name }} --zone us-central1-a\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Deploy application: Use 'Deploy to Kubernetes' workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. View in console: https://console.cloud.google.com/kubernetes/list?project=${{ secrets.GCP_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify on Failure
        if: failure()
        run: |
          echo "## ‚ùå Terraform Apply Failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY

  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'destroy'
    environment: 
      name: destroy-approval
    
    defaults:
      run:
        working-directory: ${{ github.event.inputs.working_directory || 'terraform' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.GCP_PROJECT_ID }}-tfstate" \
            -backend-config="prefix=terraform/state"

      - name: Terraform Plan Destroy
        run: |
          terraform plan -destroy \
            -var="gcp_project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -out=tfplan-destroy

      - name: Terraform Destroy
        run: |
          if [ "${{ github.event.inputs.auto_approve }}" = "true" ]; then
            terraform destroy \
              -var="gcp_project_id=${{ secrets.GCP_PROJECT_ID }}" \
              -auto-approve
          else
            terraform apply tfplan-destroy
          fi

      - name: Destroy Summary
        run: |
          echo "## Terraform Destroy Complete! üóëÔ∏è" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All infrastructure has been destroyed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**‚ö†Ô∏è Warning:** This action cannot be undone!" >> $GITHUB_STEP_SUMMARY

  terraform-drift-detection:
    name: Detect Configuration Drift
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.action == 'plan'
    
    defaults:
      run:
        working-directory: terraform
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.GCP_PROJECT_ID }}-tfstate" \
            -backend-config="prefix=terraform/state"

      - name: Terraform Plan for Drift
        id: drift
        run: |
          terraform plan \
            -var="gcp_project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -detailed-exitcode \
            -no-color
        continue-on-error: true

      - name: Check for Drift
        run: |
          if [ ${{ steps.drift.outputs.exitcode }} -eq 2 ]; then
            echo "## ‚ö†Ô∏è Configuration Drift Detected!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your infrastructure has drifted from the Terraform state." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:** Review the drift and run terraform apply if needed." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "## ‚úÖ No Configuration Drift" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure matches Terraform state." >> $GITHUB_STEP_SUMMARY
          fi

